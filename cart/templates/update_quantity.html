<style>
/* Estilos para el loading moderno */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(26, 26, 46, 0.95);
    backdrop-filter: blur(8px);
    z-index: 100;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    border-radius: 12px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.loading-overlay.active {
    opacity: 1;
    visibility: visible;
}

/* Spinner moderno con anillos múltiples */
.modern-spinner {
    position: relative;
    width: 50px;
    height: 50px;
}

.spinner-ring {
    position: absolute;
    width: 100%;
    height: 100%;
    border: 2px solid transparent;
    border-radius: 50%;
    animation: spin 2s linear infinite;
}

.spinner-ring:nth-child(1) {
    border-top-color: #00d4ff;
    animation-duration: 1.5s;
}

.spinner-ring:nth-child(2) {
    border-right-color: #ff006e;
    animation-duration: 2s;
    animation-direction: reverse;
}

.spinner-ring:nth-child(3) {
    border-bottom-color: #8338ec;
    animation-duration: 2.5s;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Texto de loading */
.loading-text {
    margin-top: 15px;
    font-size: 14px;
    font-weight: 500;
    color: #ffffff;
    opacity: 0.9;
}

.loading-text::after {
    content: '';
    animation: dots 1.5s infinite;
}

@keyframes dots {
    0%, 20% { content: ''; }
    40% { content: '.'; }
    60% { content: '..'; }
    80%, 100% { content: '...'; }
}
</style>

<div style="display: flex; flex-direction: row; align-items: center; color: #FFFFFF; position: relative; min-height: 100px; width: 100%; box-sizing: border-box;">
    <!-- Loading moderno -->
    <div id="loading-spinner-{{ cart_product.id }}" class="loading-overlay">
        <div class="modern-spinner">
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
        </div>
        <div class="loading-text">Actualizando cantidad</div>
    </div>

    <p style="margin-right: 10px;">Cantidad:</p>
    <form id="quantity-form-{{ cart_product.id }}" class="quantity-form" method="post" action="{% url 'update_cart_product' %}" style="display: flex; align-items: center;">
        {% csrf_token %}
        <input type="hidden" name="cart_product_id" value="{{ cart_product.id }}">
        <input type="hidden" name="new_quantity" id="new_quantity-{{ cart_product.id }}" value="{{ cart_product.quantity }}">
        
        <button type="button" class="btn btn-danger" id="remove-{{ cart_product.id }}" onclick="updateQuantity({{ cart_product.id }}, -1)" style="width: 40px; height: 40px; font-size: 24px;">-</button>
        <span id="quantity-{{ cart_product.id }}" style="font-size: 18px; margin: 0 10px;">{{ cart_product.quantity }}</span>
        <button type="button" class="btn btn-danger" id="add-{{ cart_product.id }}" onclick="updateQuantity({{ cart_product.id }}, 1)" style="width: 40px; height: 40px; font-size: 24px;">+</button>

        <button type="submit" style="display: none;" id="submit-{{ cart_product.id }}">Actualizar</button>
    </form>
</div>

<script>
    function showLoading(cartProductId) {
        const loadingElement = document.getElementById('loading-spinner-' + cartProductId);
        loadingElement.style.display = 'flex';
        setTimeout(() => {
            loadingElement.classList.add('active');
        }, 10);
    }

    function hideLoading(cartProductId) {
        const loadingElement = document.getElementById('loading-spinner-' + cartProductId);
        loadingElement.classList.remove('active');
        setTimeout(() => {
            loadingElement.style.display = 'none';
        }, 300);
    }

    function updateQuantity(cartProductId, change) {
        let quantityElement = document.getElementById('quantity-' + cartProductId);
        let currentQuantity = parseInt(quantityElement.innerText);
        let newQuantity = currentQuantity + change;
        const stock = {{ product.stock }};

        if (newQuantity == stock + 1) {
            console.log("Cantidad solicitada excede el stock disponible");
            hideLoading(cartProductId);
            return;
        }

 
        if (newQuantity <= 0) {
            console.log("La cantidad no puede ser menor a 1");
            hideLoading(cartProductId);
            return;
        }

        if (newQuantity > stock) {
            newQuantity = stock;
            console.log("La cantidad solicitada excede el stock disponible. Se ajustará a " + stock);
        }


        if (newQuantity > 0 && newQuantity <= stock) {
            // Mostrar loading
            showLoading(cartProductId);
            
            // Deshabilitar botones
            document.getElementById('remove-' + cartProductId).disabled = true;
            document.getElementById('add-' + cartProductId).disabled = true;
            
            // Actualizar cantidad en pantalla
            quantityElement.innerText = newQuantity;
            document.getElementById('new_quantity-' + cartProductId).value = newQuantity;
            
            console.log("Nueva cantidad: " + newQuantity);
            
            // Enviar formulario
            let form = document.getElementById('quantity-form-' + cartProductId);
            form.submit();
        } else {
            hideLoading(cartProductId);
        }
    }

    // Ocultar todos los spinners al cargar la página
    document.addEventListener('DOMContentLoaded', function () {
        let allSpinners = document.querySelectorAll('.loading-overlay');
        allSpinners.forEach(function(spinner) {
            spinner.style.display = 'none';
            spinner.classList.remove('active');
        });
    });

    // Reactivar botones cuando la página se recarga (después del submit)
    window.addEventListener('load', function() {
        const cartProductId = {{ cart_product.id }};
        
        // Reactivar botones
        const removeBtn = document.getElementById('remove-' + cartProductId);
        const addBtn = document.getElementById('add-' + cartProductId);
        
        if (removeBtn) removeBtn.disabled = false;
        if (addBtn) addBtn.disabled = false;
        
        // Ocultar loading
        hideLoading(cartProductId);
    });
</script>